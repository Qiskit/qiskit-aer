# Copyright 2018, IBM.
#
# This source code is licensed under the Apache License, Version 2.0 found in
# the LICENSE.txt file in the root directory of this source tree.
notifications:
  email: false
cache:
  pip: true
  directories:
    - .stestr
sudo: false
env:
  - QISKIT_SUPPRESS_PACKAGING_WARNINGS=Y
os: linux
dist: bionic
language: python
python: 3.7
sudo: true
before_install:
    - sudo apt-get -y update
    - sudo apt-get -y install g++-7
    - sudo apt-get -y install libopenblas-dev
before_script:
  - |
    if [ ! "$(ls -A .stestr)" ]; then
      rm -rf .stestr
    fi
  # Build with Thrust OpenMP CPU backend
  - python setup.py bdist_wheel -- -DCMAKE_CXX_COMPILER=g++-7 -DAER_THRUST_BACKEND=OMP -- -j4
  - pip install dist/qiskit_aer*whl
install:
  - pip install -U pip
  - pip install cython
  # Install terra from master on aer master else use the most recent release
  - |
    if [[ $TRAVIS_BRANCH == "master" ]] ; then
        pip install -c constraints.txt https://github.com/Qiskit/qiskit-terra/archive/master.zip
    else
        pip install -U -c constraints.txt qiskit-terra
    fi
  # Installing qiskit-aer...
  - pip install -U -c constraints.txt -r requirements-dev.txt

script:
  - pip check
  - stestr run --slowest

# Define the order of the stages.
stages:
  - name: compile
    if: tag IS blank
  - name: test
    if: tag IS blank

# Define the job matrix explicitly, as matrix expansion causes issues when
# using it with stages and some variables/sections cannot be overridden.
jobs:
  include:
  # Power tests (currently failing)
  allow_failures:
    # Power Build test
    - stage: compile
      name: Python Wheel Build Linux (Power)
      arch: ppc64le
      before_script: true
      script:
        - python setup.py bdist_wheel -- -DCMAKE_CXX_COMPILER=g++-7 -DAER_THRUST_BACKEND=OMP -- -j4
    # Linux Standalone
    - stage: compile
      name: Standalone Build Linux (Power)
      arch: ppc64le
      install:
        - pip install conan
      before_script: true
      script:
        - mkdir out; cd out; cmake ..
        - make
    # Power/Linux, Python 3.7
    - stage: test
      arch: ppc64le
      name: Python 3.7 Tests Linux (Power)
      python: 3.7
