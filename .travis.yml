# Copyright 2018, IBM.
#
# This source code is licensed under the Apache License, Version 2.0 found in
# the LICENSE.txt file in the root directory of this source tree.

language: python

install_linux: &stage_linux
  os: linux
  dist: trusty
  before_install:
    - sudo add-apt-repository -y ppa:ubuntu-toolchain-r/test
    - sudo apt-get -y update
    - sudo apt-get -y install g++-7
    - sudo apt-get -y install cmake
    - sudo apt-get -y install libopenblas-dev
  install:
    # Installing qiskit-terra master branch...
    - git clone https://github.com/Qiskit/qiskit-terra.git
    - cd qiskit-terra
    - pip install -r requirements.txt
    - pip install -r requirements-dev.txt
    - python ./setup.py install
    - cd ..
    # Installing qiskit-aer...
    - pip install -r requirements-dev.txt
    - python setup.py bdist_wheel -- -DCMAKE_CXX_COMPILER=g++-7 -- -j2
    - pip install dist/qiskit_aer*whl

install_osx: &stage_osx
  os: osx
  osx_image: xcode9.2
  language: generic
  cache:
    pip: true
    directories:
      - ~/python-interpreters/
  before_install:
    # Travis does not provide support for Python 3 under osx - it needs to be
    # installed manually.
    - brew install libomp
    - brew install openblas
    - |
      if [ ${TRAVIS_OS_NAME} = "osx" ]; then
        if [[ ! -d ~/python-interpreters/$PYTHON_VERSION ]]; then
          git clone git://github.com/pyenv/pyenv.git
          cd pyenv/plugins/python-build
          ./install.sh
          cd ../../..
          python-build $PYTHON_VERSION ~/python-interpreters/$PYTHON_VERSION
        fi
        virtualenv --python ~/python-interpreters/$PYTHON_VERSION/bin/python venv
        source venv/bin/activate
      fi

  install:
    # Installing qiskit-terra master branch...
    - git clone https://github.com/Qiskit/qiskit-terra.git
    - cd qiskit-terra
    - pip install -r requirements.txt
    - pip install -r requirements-dev.txt
    - python ./setup.py install
    - cd ..
    # Installing qiskit-aer...
    - pip install -r requirements-dev.txt
    - python setup.py bdist_wheel --plat-name macosx-10.9-x86_64 -- -DSTATIC_LINKING=False -- -j2
    - pip install dist/qiskit_aer*whl

script:
  - mv qiskit qiskit.disable
  - python -m unittest discover -s test -v

matrix:
  fast_finish: true
  include:
    - python: "3.5"
      <<: *stage_linux
      name: "Python 3.5 Tests"
    - python: "3.6"
      <<: *stage_linux
      name: "Python 3.6 Tests"
    - os: linux
      <<: *stage_linux
      dist: xenial
      python: "3.7"
      sudo: true
      name: "Python 3.7 Tests"
    # OSX, Python 3.5.6 (via pyenv)
    - name: "Python 3.5 Tests on OSX"
      <<: *stage_osx
      env:
        - PYTHON_VERSION=3.5.6
    # OSX, Python 3.6.5 (via pyenv)
    - name: "Python 3.6 Tests on OSX"
      <<: *stage_osx
      env:
        - PYTHON_VERSION=3.6.5
    # OSX, Python 3.7.2 (via pyenv)
    - name: "Python 3.7 Tests on OSX"
      <<: *stage_osx
      env:
        - PYTHON_VERSION=3.7.2
